<!DOCTYPE html>
<html>
<head>
  <title>Crypto Compatibility Test</title>
  <script type="module">
    import { pbkdf2 } from 'https://esm.sh/@noble/hashes@1.3.3/pbkdf2';
    import { sha256 } from 'https://esm.sh/@noble/hashes@1.3.3/sha256';
    import { gcm } from 'https://esm.sh/@noble/ciphers@0.5.1/aes';

    const PBKDF2_ITERATIONS = 100000;

    function bufferToHex(buffer) {
      return Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    function base64ToBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    async function testCrypto() {
      const password = document.getElementById('password').value;
      const saltBase64 = document.getElementById('salt').value;
      const verifierJson = document.getElementById('verifier').value;

      const salt = base64ToBuffer(saltBase64);
      const passwordBytes = new TextEncoder().encode(password);

      const results = document.getElementById('results');
      results.innerHTML = '<h3>Testing...</h3>';

      try {
        // 1. Web Crypto API로 키 파생
        const keyMaterial = await crypto.subtle.importKey(
          'raw', passwordBytes, 'PBKDF2', false, ['deriveBits', 'deriveKey']
        );
        const webCryptoKey = await crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt, iterations: PBKDF2_ITERATIONS, hash: 'SHA-256' },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          true, // extractable for comparison
          ['encrypt', 'decrypt']
        );
        const webCryptoKeyRaw = await crypto.subtle.exportKey('raw', webCryptoKey);
        const webCryptoKeyHex = bufferToHex(webCryptoKeyRaw);

        // 2. @noble/hashes로 키 파생
        const nobleKey = pbkdf2(sha256, passwordBytes, salt, { c: PBKDF2_ITERATIONS, dkLen: 32 });
        const nobleKeyHex = bufferToHex(nobleKey);

        // 3. 키 비교
        const keysMatch = webCryptoKeyHex === nobleKeyHex;

        // 4. Verifier 복호화 테스트
        let webDecryptResult = 'N/A';
        let nobleDecryptResult = 'N/A';

        if (verifierJson) {
          const vData = JSON.parse(verifierJson);
          const encrypted = base64ToBuffer(vData.encrypted);
          const iv = base64ToBuffer(vData.iv);

          // Web Crypto API로 복호화
          try {
            const decrypted = await crypto.subtle.decrypt(
              { name: 'AES-GCM', iv },
              webCryptoKey,
              encrypted
            );
            webDecryptResult = new TextDecoder().decode(decrypted);
          } catch (e) {
            webDecryptResult = 'FAILED: ' + e.message;
          }

          // @noble/ciphers로 복호화
          try {
            const aes = gcm(nobleKey, iv);
            const decrypted = aes.decrypt(encrypted);
            nobleDecryptResult = new TextDecoder().decode(decrypted);
          } catch (e) {
            nobleDecryptResult = 'FAILED: ' + e.message;
          }
        }

        results.innerHTML = `
          <h3>Results</h3>
          <table border="1" cellpadding="8">
            <tr><th>Item</th><th>Web Crypto API</th><th>@noble/hashes</th><th>Match</th></tr>
            <tr>
              <td>PBKDF2 Key (hex)</td>
              <td style="font-family:monospace;font-size:10px;word-break:break-all">${webCryptoKeyHex}</td>
              <td style="font-family:monospace;font-size:10px;word-break:break-all">${nobleKeyHex}</td>
              <td style="color:${keysMatch ? 'green' : 'red'}">${keysMatch ? '✓ MATCH' : '✗ MISMATCH'}</td>
            </tr>
            <tr>
              <td>Verifier Decrypt</td>
              <td>${webDecryptResult}</td>
              <td>${nobleDecryptResult}</td>
              <td style="color:${webDecryptResult === nobleDecryptResult ? 'green' : 'red'}">${webDecryptResult === nobleDecryptResult ? '✓' : '✗'}</td>
            </tr>
          </table>
        `;
      } catch (e) {
        results.innerHTML = `<h3 style="color:red">Error: ${e.message}</h3><pre>${e.stack}</pre>`;
      }
    }

    window.testCrypto = testCrypto;
  </script>
</head>
<body style="font-family: Arial; padding: 20px;">
  <h1>Web Crypto API vs @noble/hashes Compatibility Test</h1>

  <div style="margin-bottom: 10px;">
    <label>Master Password:</label><br>
    <input type="text" id="password" style="width: 300px; padding: 8px;" placeholder="Enter master password">
  </div>

  <div style="margin-bottom: 10px;">
    <label>Salt (Base64):</label><br>
    <input type="text" id="salt" style="width: 500px; padding: 8px;" value="ZfGZad/DUGkkI4j86VUwrKCE+J5n5eYCDTnlZU5tLiQ=">
  </div>

  <div style="margin-bottom: 10px;">
    <label>Verifier (JSON):</label><br>
    <textarea id="verifier" style="width: 500px; height: 60px; padding: 8px;">{"encrypted":"HF7DK+46pQ3tKmTaVgujzojzkE+4IRgoRUU7oKRSc/RJ","iv":"L9MeKA5c1vM3VjKL"}</textarea>
  </div>

  <button onclick="testCrypto()" style="padding: 10px 20px; font-size: 16px;">Test Compatibility</button>

  <div id="results" style="margin-top: 20px;"></div>
</body>
</html>
